<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=5.0"
  />
  <title>2025DKUæ˜¥ä¹‹å£°æ™ºèƒ½ä¹è°±</title>
  <!-- å¼•å…¥ PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    /* é«˜ç«¯å¤§æ°”çš„ç•Œé¢æ ·å¼ */
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --bg-color: #f0f2f5;
      --control-bg: rgba(255, 255, 255, 0.95);
      --nav-bg: #ffffff;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }
    body {
      margin: 0;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background: var(--bg-color);
      overscroll-behavior-y: contain;
      color: var(--primary);
    }
    #viewerContainer {
      width: 100vw;
      height: 100dvh;
      position: relative;
      overflow-x: hidden;
      padding-top: 50px; /* ä¸ºç•Œé¢é¢„ç•™é¡¶éƒ¨ç©ºé—´ */
    }
    .pdfPage {
      margin: 1rem auto;
      box-shadow: var(--shadow);
      background: #fff;
      transition: transform 0.2s;
      border-radius: 8px;
      overflow: hidden;
    }
    #controlPanel {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 1rem;
      background: var(--control-bg);
      padding: 1rem;
      border-radius: 2rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      z-index: 10;
    }
    .controlBtn {
      width: 3.5rem;
      height: 3.5rem;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .controlBtn:hover {
      transform: scale(1.05);
    }
    #navPanel {
      position: fixed;
      top: 0;
      left: -100%;
      width: 80%;
      height: 100%;
      background: var(--nav-bg);
      box-shadow: 4px 0 16px rgba(0, 0, 0, 0.1);
      transition: left 0.3s;
      padding: 2rem 1.5rem;
      overflow-y: auto;
      z-index: 10;
    }
    .navItem {
      padding: 1rem;
      margin: 0.5rem 0;
      background: #f7f7f7;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
    }
    .navItem:hover {
      background: #eaeaea;
      transform: translateX(5px);
    }
    .progressBar {
      height: 4px;
      background: var(--secondary);
      transition: width 0.3s ease;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 20;
    }
    #errorMsg {
      color: red;
      text-align: center;
      margin-top: 1rem;
      font-size: 0.95rem;
      font-weight: 500;
    }
    @media (min-width: 768px) {
      #navPanel {
        width: 320px;
        left: -320px;
      }
    }
  </style>
</head>
<body>
  <!-- è¿›åº¦æ¡ -->
  <div class="progressBar" id="loadingProgress" style="width:0%;"></div>
  <!-- PDFæ˜¾ç¤ºåŒºåŸŸ -->
  <div id="viewerContainer"></div>
  <!-- æ§åˆ¶é¢æ¿ -->
  <div id="controlPanel">
    <button class="controlBtn" id="navToggle" aria-label="åˆ‡æ¢æ›²ç›®åˆ—è¡¨">ğŸ“‚</button>
    <button class="controlBtn" id="zoomOut" aria-label="ç¼©å°">ï¹£</button>
    <button class="controlBtn" id="zoomIn" aria-label="æ”¾å¤§">ï¹¢</button>
    <!-- åˆ‡æ¢ä¹è°±ç±»å‹æŒ‰é’®ï¼ˆä»…å½“åŒæ—¶å­˜åœ¨äº”çº¿è°±å’Œç®€è°±æ—¶æ˜¾ç¤ºï¼‰ -->
    <button
      class="controlBtn"
      id="toggleNotation"
      aria-label="åˆ‡æ¢ç®€è°±/äº”çº¿è°±"
      style="display:none;"
    >
      ç®€/äº”
    </button>
  </div>
  <!-- å¯¼èˆªä¾§æ  -->
  <div id="navPanel">
    <h2 style="margin-bottom: 1.5rem; color: var(--primary);">æ›²ç›®åˆ—è¡¨</h2>
    <div id="songList"></div>
  </div>
  <!-- é”™è¯¯æç¤º -->
  <div id="errorMsg"></div>

  <script>
    // ---------------------------
    // 1. å¦‚æœ fetch å¤±è´¥ï¼Œåˆ™ä½¿ç”¨æ­¤å›é€€æ¸…å•
    //    è¿™é‡Œä»…ä½œç¤ºä¾‹ï¼Œè¯·è‡ªè¡Œæ·»åŠ /ä¿®æ”¹æ¡ç›®
    // ---------------------------
    const fallbackManifest = [
      {
        "name": "1. Auld Lang Syne.pdf",
        "path": "pdfs/1. Auld Lang Syne.pdf"
      },
      {
        "name": "2. Nisi Dominus.pdf",
        "path": "pdfs/2. Nisi Dominus.pdf"
      },
      {
        "name": "3. Good Luck-Babe.pdf",
        "path": "pdfs/3. Good Luck-Babe.pdf"
      },
      {
        "name": "4. æ©¡æ ‘.pdf",
        "path": "pdfs/4. æ©¡æ ‘.pdf"
      },
      {
        "name": "4. æ©¡æ ‘ï¼ˆç®€è°±ï¼‰.pdf",
        "path": "pdfs/4. æ©¡æ ‘ï¼ˆç®€è°±ï¼‰.pdf"
      },
      {
        "name": "5. Frozen.pdf",
        "path": "pdfs/5. Frozen.pdf"
      }
    ];

    // å…¨å±€çŠ¶æ€å˜é‡
    let currentPDF = null;
    let currentScale = 1.2;
    let currentIndex = 0;
    let songList = [];
    // å½“å‰æ˜¾ç¤ºä¹è°±ç±»å‹ï¼š'wuXian' ä¸ºäº”çº¿è°±ï¼Œ'jianPu' ä¸ºç®€è°±
    let currentNotation = 'wuXian';
    let resizeTimer = null;

    // ---------------------------
    // 2. åˆå§‹åŒ–ï¼šåŠ è½½æ›²ç›®åˆ—è¡¨å¹¶ç»‘å®šäº‹ä»¶
    // ---------------------------
    (async () => {
      try {
        songList = await fetchSongList();
        renderSongList();
        loadPDF(currentIndex);
      } catch (err) {
        // å¦‚æœ fetchSongList æŠ›å‡ºé”™è¯¯ï¼Œåˆ™æç¤º
        showError(
          "æ— æ³•åŠ è½½æ›²ç›®åˆ—è¡¨ï¼š\n" +
            "1. å¦‚æœæ‚¨åœ¨æœ¬åœ° file:// åè®®ä¸‹æ‰“å¼€ï¼Œè¯·ä½¿ç”¨å›é€€æ¸…å•æˆ–å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨ã€‚\n" +
            "2. è‹¥å·²éƒ¨ç½²æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ manifest.json è·¯å¾„æ˜¯å¦æ­£ç¡®ã€‚"
        );
        // ä½¿ç”¨å›é€€æ¸…å•
        songList = processFiles(fallbackManifest);
        renderSongList();
        loadPDF(currentIndex);
      }

      // æ‰‹åŠ¿æ”¯æŒï¼šå·¦å³æ»‘åŠ¨åˆ‡æ¢æ›²ç›®
      let touchStartX = 0;
      document.addEventListener(
        "touchstart",
        (e) => {
          touchStartX = e.touches[0].clientX;
        },
        { passive: true }
      );
      document.addEventListener(
        "touchend",
        (e) => {
          const deltaX = e.changedTouches[0].clientX - touchStartX;
          if (Math.abs(deltaX) > 50) {
            deltaX > 0 ? prevSong() : nextSong();
          }
        },
        { passive: true }
      );

      // é”®ç›˜æ”¯æŒï¼šå·¦å³ç®­å¤´åˆ‡æ¢
      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") prevSong();
        else if (e.key === "ArrowRight") nextSong();
      });

      // æ§åˆ¶æŒ‰é’®äº‹ä»¶ç»‘å®š
      document.getElementById("navToggle").addEventListener("click", toggleNav);
      document.getElementById("zoomOut").addEventListener("click", () =>
        adjustZoom(0.9)
      );
      document.getElementById("zoomIn").addEventListener("click", () =>
        adjustZoom(1.1)
      );
      document
        .getElementById("toggleNotation")
        .addEventListener("click", toggleNotation);

      // çª—å£å°ºå¯¸è°ƒæ•´æ—¶é˜²æŠ–å¤„ç†
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          if (currentPDF) loadPDF(currentIndex);
        }, 300);
      });
    })();

    // ---------------------------
    // 3. è·å–æ›²ç›®åˆ—è¡¨
    // ---------------------------
    async function fetchSongList() {
      // è‹¥åœ¨æœ¬åœ° file:// åè®®ä¸‹ï¼Œå¯ç›´æ¥æŠ›é”™ï¼Œèµ°å›é€€æ¸…å•
      if (location.protocol === "file:") {
        throw new Error("file:// protocol not allowed fetch in many browsers.");
      }
      // è‹¥åœ¨æœåŠ¡å™¨æˆ–å…è®¸æœ¬åœ° fetch çš„ç¯å¢ƒï¼Œåˆ™å°è¯•è·å– manifest.json
      const response = await fetch("pdfs/manifest.json");
      if (!response.ok) throw new Error("ç½‘ç»œé”™è¯¯");
      const files = await response.json();
      return processFiles(files);
    }

    // å°†æ–‡ä»¶æ•°ç»„è½¬æ¢ä¸ºå†…éƒ¨çš„ songList ç»“æ„
    function processFiles(files) {
      const songs = {};
      files.forEach((file) => {
        // åŒ¹é…æ ¼å¼: "4. æ©¡æ ‘.pdf" æˆ– "4. æ©¡æ ‘ï¼ˆç®€è°±ï¼‰.pdf"
        const match = file.name.match(/^(\d+)\.\s*(.+?)(ï¼ˆç®€è°±ï¼‰)?\.pdf$/i);
        if (match) {
          const id = parseInt(match[1]);
          const baseName = match[2].trim();
          const isJianpu = Boolean(match[3]);
          if (!songs[id]) {
            songs[id] = {
              id: id,
              name: baseName,
              wuXianPath: null,
              jianPuPath: null,
            };
          }
          if (isJianpu) {
            songs[id].jianPuPath = file.path;
          } else {
            songs[id].wuXianPath = file.path;
          }
        }
      });
      return Object.values(songs).sort((a, b) => a.id - b.id);
    }

    // ---------------------------
    // 4. æ¸²æŸ“ä¾§è¾¹å¯¼èˆªåˆ—è¡¨
    // ---------------------------
    function renderSongList() {
      const listContainer = document.getElementById("songList");
      listContainer.innerHTML = songList
        .map(
          (song, index) => `
          <div class="navItem" data-index="${index}">
              <div style="font-weight: 500;">${song.name}</div>
              <div style="font-size: 0.875em; color: #666;">
                ç¼–å·ï¼š${String(song.id).padStart(2, "0")}
              </div>
          </div>
      `
        )
        .join("");
      Array.from(listContainer.getElementsByClassName("navItem")).forEach(
        (item) => {
          item.addEventListener("click", () => {
            loadPDF(parseInt(item.getAttribute("data-index")));
            toggleNav(); // åŠ è½½åå…³é—­å¯¼èˆªé¢æ¿
          });
        }
      );
    }

    // ---------------------------
    // 5. åŠ è½½å¹¶æ¸²æŸ“ PDF
    // ---------------------------
    async function loadPDF(index) {
      if (!songList[index]) return;
      currentIndex = index;
      const song = songList[index];
      // æ ¹æ®æ›²ç›®æ–‡ä»¶æƒ…å†µç¡®å®šé»˜è®¤æ¨¡å¼ï¼šè‹¥å­˜åœ¨äº”çº¿è°±åˆ™ä¼˜å…ˆæ˜¾ç¤ºï¼Œå¦åˆ™æ˜¾ç¤ºç®€è°±
      if (!song.wuXianPath && song.jianPuPath) {
        currentNotation = "jianPu";
      } else {
        currentNotation = "wuXian";
      }
      updateToggleBtnVisibility(song);
      updateProgress(0);
      try {
        if (currentPDF && typeof currentPDF.destroy === "function") {
          currentPDF.destroy();
        }
        const path =
          currentNotation === "wuXian" ? song.wuXianPath : song.jianPuPath;
        if (!path) {
          throw new Error("å¯¹åº”çš„ä¹è°±æ–‡ä»¶ä¸å­˜åœ¨");
        }
        const loadingTask = pdfjsLib.getDocument(path);
        currentPDF = await loadingTask.promise;
        const container = document.getElementById("viewerContainer");
        container.innerHTML = "";
        for (let pageNum = 1; pageNum <= currentPDF.numPages; pageNum++) {
          updateProgress((pageNum / currentPDF.numPages) * 90);
          const page = await currentPDF.getPage(pageNum);
          await renderPage(page, container);
        }
        updateProgress(100);
      } catch (error) {
        console.error("PDFåŠ è½½å¤±è´¥:", error);
        showError("PDFåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„æˆ–æµè§ˆå™¨å®‰å…¨è®¾ç½®ã€‚");
        updateProgress(0);
      }
    }

    // æ¸²æŸ“å•é¡µ
    async function renderPage(page, container) {
      const viewport = page.getViewport({ scale: currentScale });
      const wrapper = document.createElement("div");
      wrapper.className = "pdfPage";
      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      wrapper.appendChild(canvas);
      container.appendChild(wrapper);
      await page.render({ canvasContext: context, viewport: viewport }).promise;
    }

    // ---------------------------
    // 6. åŠŸèƒ½å‡½æ•°ï¼šç¼©æ”¾ã€åˆ‡æ¢ã€å¯¼èˆª
    // ---------------------------
    // ç¼©æ”¾æ§åˆ¶ï¼šè°ƒæ•´ç¼©æ”¾æ¯”ä¾‹åé‡æ–°åŠ è½½PDF
    function adjustZoom(factor) {
      const newScale = Math.min(Math.max(currentScale * factor, 0.5), 3);
      if (newScale !== currentScale) {
        currentScale = newScale;
        if (currentPDF) loadPDF(currentIndex);
      }
    }

    // åˆ‡æ¢ä¹è°±ç±»å‹ï¼šåœ¨ç®€è°±ä¸äº”çº¿è°±é—´åˆ‡æ¢
    function toggleNotation() {
      currentNotation = currentNotation === "wuXian" ? "jianPu" : "wuXian";
      loadPDF(currentIndex);
    }

    // æ ¹æ®å½“å‰æ›²ç›®åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºåˆ‡æ¢æŒ‰é’®
    function updateToggleBtnVisibility(song) {
      const toggleBtn = document.getElementById("toggleNotation");
      if (song.wuXianPath && song.jianPuPath) {
        toggleBtn.style.display = "flex";
        toggleBtn.textContent =
          currentNotation === "wuXian" ? "åˆ‡äº”â†’ç®€" : "åˆ‡ç®€â†’äº”";
      } else {
        toggleBtn.style.display = "none";
      }
    }

    // ä¸Šä¸€é¦–
    function prevSong() {
      if (currentIndex > 0) loadPDF(currentIndex - 1);
    }
    // ä¸‹ä¸€é¦–
    function nextSong() {
      if (currentIndex < songList.length - 1) loadPDF(currentIndex + 1);
    }

    // åˆ‡æ¢å¯¼èˆªé¢æ¿æ˜¾ç¤ºçŠ¶æ€
    function toggleNav() {
      const panel = document.getElementById("navPanel");
      if (panel.style.left === "0px" || panel.style.left === "0") {
        panel.style.left = `-${panel.offsetWidth}px`;
      } else {
        panel.style.left = "0px";
      }
    }

    // ---------------------------
    // 7. è¾…åŠ©å‡½æ•°ï¼šè¿›åº¦æ¡ã€é”™è¯¯æç¤º
    // ---------------------------
    // æ›´æ–°é¡¶éƒ¨è¿›åº¦æ¡
    function updateProgress(percentage) {
      document.getElementById("loadingProgress").style.width = `${percentage}%`;
      if (percentage >= 100) {
        setTimeout(() => updateProgress(0), 500);
      }
    }

    // æ˜¾ç¤ºé”™è¯¯æç¤ºä¿¡æ¯
    function showError(message) {
      const errorDiv = document.getElementById("errorMsg");
      errorDiv.textContent = message;
      setTimeout(() => {
        // è‹¥æƒ³ä¿ç•™é”™è¯¯æç¤ºï¼Œå¯å»æ‰æ­¤ setTimeout
        errorDiv.textContent = "";
      }, 4000);
    }
  </script>
</body>
</html>